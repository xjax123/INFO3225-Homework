/* autogenerated by Processing revision 1293 on 2024-03-26 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import java.util.HashMap;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class Project2 extends PApplet {

PGraphics main,hud;
SceneManager manager = new SceneManager();
String devText = "";

public void setup() {
    /* size commented out by preprocessor */;
    main = createGraphics(1920,1061,P3D);
    main.smooth(8);
    hud = createGraphics(1920,1080,P2D);
    noStroke();
    fill(50,50,50);
    PShape shape1 = createShape(BOX,50,1,50);
    MapTile m1 = new MapTile('A',shape1,true);
    tileMap.put('A',m1);
    fill(100,100,100);
    PShape shape2 = createShape(BOX,50,1,50);
    MapTile m2 = new MapTile('B',shape2,true);
    tileMap.put('B',m2);
    fill(0,255,0);
    PShape shape3 = createShape(BOX,50,50,50);
    shape3.translate(0,-25,0);
    MapTile m3 = new MapTile('C',shape3);
    tileMap.put('C',m3);
    emissive(0xFFFFA500);
    fill(0);
    PShape shape4 = createShape(BOX,50,1,50);
    shape4.translate(0,1,0);
    MapTile m4 = new DangerTile('L',shape4);
    tileMap.put('L',m4);
    emissive(0xFF000000);


    Character[][] map1 = 
    {
        {'C','L','A','B','A','L'},
        {'C','L','B','A','B','L'},
        {'C','B','A','B','A','L'},
        {'C','L','B','A','B','L'},
        {'C','L','A','B','A','L'} 
    };
    NavMap navmap1 = new NavMap(map1);

    stroke(0);
    fill(255,255,255);
    PShape ent1 = createShape(BOX,50,50,50);
    ent1.translate(0,-26,0);
    Player e1 = new Player(2,3,ent1);
    navmap1.registerEntity(e1);

    manager.registerMap(navmap1);

    Character[][] map2 = 
    {
        {'A','B','C','B','A','B'},
        {'B','A','C','A','L','A'},
        {'A','B','C','B','L','B'},
        {'B','A','C','A','L','A'},
        {'A','B','A','B','L','B'} 
    };
    NavMap navmap2 = new NavMap(map2);

    stroke(0);
    fill(255,255,255);
    PShape ent2 = createShape(BOX,50,50,50);
    ent2.translate(0,-26,0);
    Player e2 = new Player(2,3,ent2);
    navmap2.registerEntity(e2);

    manager.registerMap(navmap2);
}

public void draw() {
    main.beginDraw();

    //Background & Lighting
    main.background(0,0,0);
    main.ambientLight(75,75,75);
    main.directionalLight(150,150,150,1,1,1);

    //Camera
    main.beginCamera();
    main.camera();
    main.translate(1920/2,1080/2,0);
    main.rotateX(radians(-45));
    main.rotateY(radians(-10));
    main.endCamera();
    //scene offset
    main.translate(-150,0,-100);
    manager.getActiveMap().drawMap(main);
    main.endDraw();

    hud.beginDraw();
    hud.background(0,0,0,0);
    hud.noStroke();
    hud.fill(255, 255, 255);
    hud.textSize(64);
    hud.text("Current Pos: "+devText, 0, 64);
    hud.text("Current State: "+manager.getPlayer().state, 0, 128);
    hud.endDraw();

    image(main,0,0);
    image(hud,0,0);
}

public void keyPressed() {
    NavMap act = manager.getActiveMap();
    if (key == 'w') {
        act.moveEnt(manager.getPlayer(),Direction.UP);
    }
    if (key == 's') {
        act.moveEnt(manager.getPlayer(),Direction.DOWN);
    }
    if (key == 'a') {
        act.moveEnt(manager.getPlayer(),Direction.LEFT);
    }
    if (key == 'd') {
        act.moveEnt(manager.getPlayer(),Direction.RIGHT);
    }
    if (key == 10) {
        manager.nextScene();
    }
}


HashMap<Character, MapTile> tileMap = new HashMap<Character, MapTile>();
enum Direction {
    UP,
    DOWN,
    LEFT,
    RIGHT
};

class NavMap {
    MapTile[][] tiles;
    MapEntitiy[][] entities;

    public NavMap(NavMap map) {
        tiles = new MapTile[map.tiles.length][map.tiles[0].length];
        entities = new MapEntitiy[map.tiles.length][map.tiles[0].length];
        for (int x = 0; x < tiles.length; x++) {
            for (int y = 0; y < tiles[x].length; y++) {
                if (map.tiles[x][y] == null) {
                    tiles[x][y] = new MapTile();
                } else {
                    MapTile tile = map.tiles[x][y];
                    if (tile instanceof DangerTile) {
                        tiles[x][y] = new DangerTile(tile);
                    } else {
                        tiles[x][y] = new MapTile(tile);
                    }
                }
                if (map.entities[x][y] != null) {
                    if (map.entities[x][y] instanceof Player) {
                        entities[x][y] = new Player(map.entities[x][y]);
                    } else {
                        entities[x][y] = new MapEntitiy(map.entities[x][y]);
                    }
                }
            }
        }
    }

    public NavMap(Character[][] _mapTiles) {
        int max = 0;
        for (int i = 0; i < _mapTiles.length; i++) {
            if (_mapTiles[i].length > max) {
                max = _mapTiles[i].length;
            }
        }
        tiles = new MapTile[_mapTiles.length][max];
        entities = new MapEntitiy[_mapTiles.length][max];
        for (int x = 0; x < tiles.length; x++) {
            for (int y = 0; y < tiles[x].length; y++) {
                if (_mapTiles[x][y] == null) {
                    tiles[x][y] = new MapTile();
                } else {
                    MapTile tile = tileMap.get(_mapTiles[x][y]);
                    if (tile instanceof DangerTile) {
                        tiles[x][y] = new DangerTile(tile);
                    } else {
                        tiles[x][y] = new MapTile(tile);
                    }
                }
            }
        }
    }
    public boolean inBounds(int x, int y) {
        if (x >= 0 && x < tiles.length) {
            if (y >= 0 && y < tiles[0].length) {
                return true;
            }
        }
        return false;
    }
    public MapEntitiy getPlayer() {
        for (int x = 0; x < tiles.length; x++) {
            for (int y = 0; y < tiles[x].length; y++) {
                if (entities[x][y] instanceof Player) {
                    return entities[x][y];
                }
            }
        }
        return null;
    }
    public void registerEntity(MapEntitiy ent) {
        entities[ent.mapX][ent.mapY] = ent;
        tiles[ent.mapX][ent.mapY].walkTile(ent);
    }

    public void positionEnt(MapEntitiy ent, int newX, int newY) {
        int prevX = ent.mapX;
        int prevY = ent.mapY;
        entities[newX][newY] = ent;
        ent.mapX = newX;
        ent.mapY = newY;
        entities[prevX][prevY] = null;
    }
    //remember to update to include collision detection
    public void moveEnt(MapEntitiy ent, Direction d) {
        if (ent.state == EntState.DEAD) {
            return;
        }

        if (d == Direction.UP) {
            int newY = ent.mapY-1;
            if (inBounds(ent.mapX,newY)) {
                if (tiles[ent.mapX][newY].walkable) {
                    tiles[ent.mapX][newY].walkTile(ent);
                    positionEnt(ent,ent.mapX,newY);
                }
            }
        } else if (d == Direction.DOWN) {
            int newY = ent.mapY+1;
            if (inBounds(ent.mapX,newY)) {
                if (tiles[ent.mapX][newY].walkable) {
                    tiles[ent.mapX][newY].walkTile(ent);
                    positionEnt(ent,ent.mapX,newY);
                }       
            }
        } else if (d == Direction.LEFT) {
            int newX = ent.mapX-1;
            if (inBounds(newX,ent.mapY)) {
                if (tiles[newX][ent.mapY].walkable) {
                    tiles[newX][ent.mapY].walkTile(ent);
                    positionEnt(ent,newX,ent.mapY);
                }
            }
        } else if (d == Direction.RIGHT) {
            int newX = ent.mapX+1;
            if (inBounds(newX,ent.mapY)) {
                if (tiles[newX][ent.mapY].walkable) {
                    tiles[newX][ent.mapY].walkTile(ent);
                    positionEnt(ent,newX,ent.mapY);
                }
            }
        }
    }

    public void drawMap(PGraphics buffer) {
        main.pushMatrix();
            for (int x = 0; x < tiles.length; x++) {
                main.translate(50,0,0);
                main.pushMatrix();
                    for (int y = 0; y < tiles[x].length; y++) {
                        main.translate(0,0,50);
                        if (entities[x][y] != null) {
                            main.shape(entities[x][y].shape,0,0);
                        }
                        main.shape(tiles[x][y].shape,0,0);
                    }
                main.popMatrix();
            }
        main.popMatrix();
    }

    @Override
    public String toString() {
        String smap = "";
        smap += "[";
        for (int x = 0; x < tiles.length; x++) {
            smap += "{";
            for (int y = 0; y < tiles[x].length; y++) {
                smap += tiles[x][y].toString();
            }
            smap += "}";
        }
        smap += "]";
        return smap;
    }
}

//Tile Classes & Utils
class MapTile {
    public Character identifier;
    public PShape shape = createShape();
    public boolean walkable = false;

    public MapTile() {
        identifier = 'b';
    }
    public MapTile(MapTile copy) {
        identifier = copy.identifier;
        shape = copy.shape;
        walkable = copy.walkable;
    }
    public MapTile(Character id, PShape _shape) {
        identifier = id;
        shape = _shape;
    }
    public MapTile(Character id, PShape _shape, boolean _walkable) {
        identifier = id;
        shape = _shape;
        walkable = _walkable;
    }

    public void walkTile(MapEntitiy ent) {
        devText = "Walking on - "+identifier.toString();
    }

    @Override
    public String toString() {
        return identifier.toString();
    }
}

class DangerTile extends MapTile {
    public DangerTile(MapTile copy) {
        super(copy);
    }
    public DangerTile(Character id, PShape _shape) {
        super(id,_shape,true);
    }

    @Override
    public void walkTile(MapEntitiy ent) {
        ent.kill();
    }
}

//Entity Classes & Utils

enum EntState {
    ALIVE,
    DEAD
}

class MapEntitiy {
    public int mapX;
    public int mapY;
    public PShape shape;
    public EntState state;

    public MapEntitiy(MapEntitiy ent) {
        mapX = ent.mapX;
        mapY = ent.mapY;
        shape = ent.shape;
        state = ent.state;
        shape.setVisible(true);
    }
    public MapEntitiy(int _x, int _y, PShape _shape) {
        mapX = _x;
        mapY = _y;
        shape = _shape;
        state = EntState.ALIVE;
    }

    public void collide() {}

    public void kill() {
        println("Killed");
        state = EntState.DEAD;
        shape.setVisible(false);
    }
}

class Player extends MapEntitiy{
    public Player(MapEntitiy ent) {
        super(ent);
    }
    public Player(int _x, int _y, PShape _shape) {
        super(_x,_y,_shape);
    }
}
class SceneManager {
    ArrayList<NavMap> maps = new ArrayList<NavMap>();
    int mapIndex = 0;
    MapEntitiy mainChar;
    NavMap activeMap;
    public SceneManager() {}

    public void registerMap(NavMap map) {
        maps.add(map);
        if (activeMap == null) {
           setActiveMap(map);
        }
    }

    public NavMap getActiveMap() {
        return activeMap;
    }

    public MapEntitiy getPlayer() {
        return mainChar;
    }

    public void nextScene() {
        if (mapIndex+1 >= maps.size()) {
            mapIndex = -1;
        }
        mapIndex += 1;
        setActiveMap(maps.get(mapIndex));
    }

    private void setActiveMap(NavMap map) {
        activeMap = new NavMap(map);
        mainChar = activeMap.getPlayer();
    }
}


  public void settings() { size(1920, 1080, P3D); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "Project2" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
